<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Cursor-Depth Mapping Test</title>
    <style>
        body { font-family: 'Courier New', monospace; padding: 20px; background: #f8f8ff; }
        .test-container { background: white; border: 2px solid #666; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .broken-approach { background: #ffeeee; border-left: 5px solid #ff0000; padding: 15px; margin: 15px 0; }
        .correct-approach { background: #eeffee; border-left: 5px solid #00cc00; padding: 15px; margin: 15px 0; }
        .interactive-test { background: #f0f8ff; border: 2px solid #4169e1; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .cursor-slider { width: 100%; margin: 20px 0; }
        .visual-demo { font-family: monospace; margin: 15px 0; line-height: 2; }
        .depth-0 { padding-left: 0px; color: #000; }
        .depth-1 { padding-left: 24px; color: #333; }
        .depth-2 { padding-left: 48px; color: #666; }
        .depth-3 { padding-left: 72px; color: #999; }
        .depth-4 { padding-left: 96px; color: #aaa; }
        .highlight { background: yellow; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 14px; }
        th, td { border: 1px solid #666; padding: 8px; text-align: center; }
        th { background: #f0f0f0; }
        .error { background: #ffcccc; }
        .success { background: #ccffcc; }
    </style>
</head>
<body>
    <h1>üéØ The Cursor-Depth Mapping Investigation</h1>
    
    <div class="test-container">
        <h2>üö® Problem Identified: Array-Index vs Direct Mapping</h2>
        
        <div class="broken-approach">
            <h3>‚ùå My Broken Approach (Current)</h3>
            <p><strong>Logic:</strong> Cursor Position ‚Üí Array Index ‚Üí Depth</p>
            <pre>depthIndex = Math.floor((hoveredDepth - minDepth) / 1)
selectedDepth = validDepths[depthIndex]</pre>
            <p><strong>Problem:</strong> Unnecessary complexity and conceptual confusion</p>
        </div>

        <div class="correct-approach">
            <h3>‚úÖ Correct Approach (Should Be)</h3>
            <p><strong>Logic:</strong> Cursor Position ‚Üí Direct Depth (Clamped)</p>
            <pre>selectedDepth = Math.max(minDepth, Math.min(hoveredDepth, maxDepth))</pre>
            <p><strong>Benefit:</strong> Intuitive, direct, no array indexing complexity</p>
        </div>
    </div>

    <div class="interactive-test">
        <h2>üß™ Interactive Comparison Test</h2>
        
        <div>
            <label for="d1">Element 1 Depth (D1): </label>
            <input type="number" id="d1" value="2" min="0" max="5" style="width: 60px;">
            
            <label for="d2" style="margin-left: 20px;">Element 2 Depth (D2): </label>
            <input type="number" id="d2" value="0" min="0" max="5" style="width: 60px;">
        </div>
        
        <div style="margin: 20px 0;">
            <label for="cursor">Cursor Position (Visual Depth): </label>
            <input type="range" id="cursor" min="0" max="6" value="2" class="cursor-slider">
            <span id="cursor-value">2</span>
        </div>

        <div id="results"></div>
        
        <div class="visual-demo" id="visual-demo"></div>
    </div>

    <div class="test-container">
        <h2>üìä Comprehensive Test Matrix</h2>
        <div id="test-matrix"></div>
    </div>

    <script>
        // Mathematical formula
        function getValidDepths(d1, d2) {
            const min = Math.min(d1, d2);
            const max = Math.max(d1, d2) + 1;
            const depths = [];
            for (let i = min; i <= max; i++) depths.push(i);
            return depths;
        }

        // Broken approach (current implementation)
        function brokenMapping(hoveredDepth, validDepths) {
            const minDepth = Math.min(...validDepths);
            const depthIndex = Math.max(0, Math.min(
                Math.floor((hoveredDepth - minDepth) / 1),
                validDepths.length - 1
            ));
            return validDepths[depthIndex];
        }

        // Correct approach (should be)
        function correctMapping(hoveredDepth, validDepths) {
            const minDepth = Math.min(...validDepths);
            const maxDepth = Math.max(...validDepths);
            return Math.max(minDepth, Math.min(hoveredDepth, maxDepth));
        }

        // Update display
        function updateResults() {
            const d1 = parseInt(document.getElementById('d1').value);
            const d2 = parseInt(document.getElementById('d2').value);
            const hoveredDepth = parseInt(document.getElementById('cursor').value);
            
            document.getElementById('cursor-value').textContent = hoveredDepth;
            
            const validDepths = getValidDepths(d1, d2);
            const brokenResult = brokenMapping(hoveredDepth, validDepths);
            const correctResult = correctMapping(hoveredDepth, validDepths);
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <table>
                    <tr>
                        <th>Approach</th>
                        <th>Formula</th>
                        <th>Result</th>
                        <th>Match Expected?</th>
                    </tr>
                    <tr>
                        <td><strong>Mathematical Valid Depths</strong></td>
                        <td>[min(${d1},${d2}), max(${d1},${d2})+1]</td>
                        <td>[${validDepths.join(', ')}]</td>
                        <td>N/A</td>
                    </tr>
                    <tr class="${brokenResult === correctResult ? 'success' : 'error'}">
                        <td>‚ùå Broken (Array Index)</td>
                        <td>validDepths[index]</td>
                        <td><strong>Depth ${brokenResult}</strong></td>
                        <td>${brokenResult === correctResult ? '‚úÖ Yes' : '‚ùå No'}</td>
                    </tr>
                    <tr class="success">
                        <td>‚úÖ Correct (Direct)</td>
                        <td>clamp(cursor, min, max)</td>
                        <td><strong>Depth ${correctResult}</strong></td>
                        <td>‚úÖ Always</td>
                    </tr>
                </table>
                
                <div style="margin-top: 15px;">
                    <strong>User Expectation:</strong> Cursor at visual depth ${hoveredDepth} should map to depth ${correctResult}<br>
                    <strong>Broken Result:</strong> Maps to depth ${brokenResult} ${brokenResult !== correctResult ? '(WRONG!)' : '(works by accident)'}<br>
                    <strong>Correct Result:</strong> Maps to depth ${correctResult} (intuitive and direct)
                </div>
            `;

            // Update visual demo
            const visualDiv = document.getElementById('visual-demo');
            const depthClasses = ['depth-0', 'depth-1', 'depth-2', 'depth-3', 'depth-4'];
            visualDiv.innerHTML = `
                <div>Tree Structure (D1=${d1}, D2=${d2}):</div>
                <div class="${depthClasses[d1]}">üìÑ Element 1 (depth ${d1})</div>
                <div class="${depthClasses[hoveredDepth]} ${hoveredDepth === correctResult ? 'highlight' : ''}">üéØ Cursor Position (visual depth ${hoveredDepth})</div>
                <div class="${depthClasses[d2]}">üìÑ Element 2 (depth ${d2})</div>
                <div style="margin-top: 10px;">
                    Drop will be at: <span class="highlight">Depth ${correctResult}</span>
                </div>
            `;
        }

        // Generate test matrix
        function generateTestMatrix() {
            const matrixDiv = document.getElementById('test-matrix');
            let html = '<h3>Test Matrix: All Combinations</h3>';
            html += '<table><tr><th>D1</th><th>D2</th><th>Cursor</th><th>Valid Depths</th><th>Broken Result</th><th>Correct Result</th><th>Status</th></tr>';
            
            let totalTests = 0;
            let failures = 0;
            
            for (let d1 = 0; d1 <= 3; d1++) {
                for (let d2 = 0; d2 <= 3; d2++) {
                    for (let cursor = 0; cursor <= 5; cursor++) {
                        const validDepths = getValidDepths(d1, d2);
                        const broken = brokenMapping(cursor, validDepths);
                        const correct = correctMapping(cursor, validDepths);
                        const matches = broken === correct;
                        
                        totalTests++;
                        if (!matches) failures++;
                        
                        html += `<tr class="${matches ? 'success' : 'error'}">
                            <td>${d1}</td><td>${d2}</td><td>${cursor}</td>
                            <td>[${validDepths.join(',')}]</td>
                            <td>${broken}</td><td>${correct}</td>
                            <td>${matches ? '‚úÖ' : '‚ùå'}</td>
                        </tr>`;
                    }
                }
            }
            
            html += '</table>';
            html += `<div style="margin-top: 15px; font-weight: bold;">
                Results: ${totalTests - failures}/${totalTests} tests pass (${failures} failures)
                ${failures > 0 ? '<br>üö® Array-index approach has systematic failures!' : ''}
            </div>`;
            
            matrixDiv.innerHTML = html;
        }

        // Event listeners
        document.getElementById('d1').addEventListener('input', updateResults);
        document.getElementById('d2').addEventListener('input', updateResults);
        document.getElementById('cursor').addEventListener('input', updateResults);

        // Initial load
        updateResults();
        generateTestMatrix();

        console.log('üéØ Cursor-Depth Mapping Investigation');
        console.log('üö® Found: Array-index approach is conceptually wrong');
        console.log('‚úÖ Solution: Direct cursor-to-depth mapping with clamping');
    </script>
</body>
</html>