<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêõ Children Disappearing Bug Analysis</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #ffe6e6; }
        .bug { background: #ffcccc; border: 2px solid #ff0000; padding: 15px; margin: 15px 0; }
        .fix { background: #e6ffe6; border: 2px solid #00ff00; padding: 15px; margin: 15px 0; }
        .code { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <h1>üêõ Children Disappearing Bug - ROOT CAUSE FOUND</h1>
    
    <div class="bug">
        <h2>‚ùå BROKEN CODE (lines 456-461)</h2>
        <div class="code">ancestorIds: element.id === draggedId 
  ? newPosition.newAncestorIds 
  : element.ancestorIds.map(ancestorId => 
      ancestorId === draggedId ? newPosition.newParentId : ancestorId
    ).filter(Boolean)</div>
        
        <p><strong>Problem:</strong> This only replaces the dragged parent ID in ancestor chains, but doesn't rebuild the full ancestor chain for descendants!</p>
    </div>

    <div class="bug">
        <h2>üìã Example That Shows the Bug</h2>
        <p><strong>Before move:</strong></p>
        <ul>
            <li>Root (depth 0, ancestorIds: [])</li>
            <li>Parent (depth 1, ancestorIds: [Root])</li>
            <li>Child (depth 2, ancestorIds: [Root, Parent])</li>
        </ul>
        
        <p><strong>Move Parent to be child of NewParent:</strong></p>
        <ul>
            <li>Root (depth 0, ancestorIds: [])</li>
            <li>NewParent (depth 1, ancestorIds: [Root])</li>
            <li>Parent (depth 2, ancestorIds: [Root, NewParent]) ‚Üê CORRECT</li>
            <li>Child (depth 3, ancestorIds: [Root, NewParent]) ‚Üê <strong style="color: red;">WRONG! Missing Parent!</strong></li>
        </ul>
        
        <p><strong>Should be:</strong></p>
        <ul>
            <li>Child (depth 3, ancestorIds: [Root, NewParent, Parent]) ‚Üê CORRECT</li>
        </ul>
    </div>

    <div class="fix">
        <h2>‚úÖ THE FIX</h2>
        <p>Rebuild full ancestor chains for ALL descendants based on their relative position to the moved parent:</p>
        <div class="code">ancestorIds: element.id === draggedId 
  ? newPosition.newAncestorIds 
  : [...newPosition.newAncestorIds, draggedId, ...element.ancestorIds.slice(element.ancestorIds.indexOf(draggedId) + 1)]</div>
  
        <p><strong>Logic:</strong></p>
        <ol>
            <li>Take the moved parent's new ancestor chain</li>
            <li>Add the moved parent ID itself</li>
            <li>Add any ancestors that were below the moved parent in the original chain</li>
        </ol>
    </div>

    <script>
        console.log('üêõ Children Disappearing Bug Analysis');
        console.log('Problem: Broken ancestorIds updating logic in moveElementInFlat');
        console.log('Solution: Rebuild full ancestor chains for all descendants');
        
        // Simulate the bug
        function brokenUpdate(element, draggedId, newParentId) {
            return element.ancestorIds.map(ancestorId => 
                ancestorId === draggedId ? newParentId : ancestorId
            ).filter(Boolean);
        }
        
        // Simulate the fix
        function fixedUpdate(element, draggedId, newAncestorIds) {
            const draggedIndex = element.ancestorIds.indexOf(draggedId);
            if (draggedIndex === -1) return element.ancestorIds;
            
            return [
                ...newAncestorIds,           // New parent's ancestor chain
                draggedId,                   // The moved parent itself
                ...element.ancestorIds.slice(draggedIndex + 1)  // Remaining chain below moved parent
            ];
        }
        
        // Test the difference
        const childAncestors = ['Root', 'Parent'];
        const draggedId = 'Parent';
        const newParentAncestors = ['Root', 'NewParent'];
        
        console.log('‚ùå Broken result:', brokenUpdate({ ancestorIds: childAncestors }, draggedId, 'NewParent'));
        console.log('‚úÖ Fixed result:', fixedUpdate({ ancestorIds: childAncestors }, draggedId, newParentAncestors));
    </script>
</body>
</html>